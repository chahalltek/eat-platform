datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UsageEventType {
  JOBS_PROCESSED
  CANDIDATES_EVALUATED
  AGENT_RUN
  EXPLAIN_CALL
  COPILOT_CALL
}

enum CostDriverType {
  LLM_CALL
  FORECAST_RUNTIME
  AGGREGATION_RUNTIME
}

enum ActionType {
  WIDEN_CRITERIA
  ADJUST_COMP
  SOURCE_EXTERNALLY
  ESCALATE_TO_HM
  PUSH_CANDIDATES
  PAUSE_REQUISITION
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum ExecutionStatus {
  SUCCESS
  FAILED
}

enum DecisionStatus {
  DRAFT
  PUBLISHED
}

enum TenantDeletionMode {
  SOFT_DELETE
  HARD_DELETE
}

enum AgentRunStatus {
  RUNNING
  SUCCESS
  FAILED
  PARTIAL
}

enum JudgmentAgent {
  MATCH
  CONFIDENCE
  EXPLAIN
  SHORTLIST
}

enum JudgmentDecisionType {
  submit
  reject
  override
  confidence_adjustment
}

enum JudgmentAggregateDimension {
  firm
  client
  role_type
}

enum JobCandidateStatus {
  POTENTIAL // AI suggests
  SHORTLISTED // recruiter likes
  SUBMITTED // sent to client
  INTERVIEWING
  HIRED
  REJECTED
}

enum HiringManagerBriefStatus {
  DRAFT
  READY
  SENT
}

enum HiringManagerFeedbackType {
  REQUIREMENT_CHANGED
  CANDIDATE_REJECTED
  CANDIDATE_UPDATED
  THRESHOLD_ADJUSTED
}

enum HiringManagerFeedbackStatus {
  SUBMITTED
  PROCESSED
}

enum DecisionArtifactType {
  RECOMMENDATION
  SHORTLIST
  INTAKE_SUMMARY
}

enum DecisionArtifactStatus {
  DRAFT
  PUBLISHED
}

model User {
  id          String   @id @default(cuid())
  tenantId    String   @default("default-tenant")
  email       String
  displayName String
  role        String // "Recruiter", "Sourcer", "Sales", "Admin"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant            Tenant       @relation(fields: [tenantId], references: [id])
  tenantMemberships TenantUser[]

  agentRuns             AgentRunLog[]
  jobCandidates         JobCandidate[]
  decisionStreams       DecisionStream[]
  identities            UserIdentity[]
  securityEvents        SecurityEventLog[]
  matchHistories        MatchHistory[]
  jobCandidateNotes     JobCandidateNote[]
  jobCandidateHistories JobCandidateHistory[]
  matchFeedback         MatchFeedback[]
  jobIntents            JobIntent[]
  decisionArtifacts     DecisionArtifact[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model UserIdentity {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  provider  String
  subject   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, subject])
  @@index([userId])
}

model Tenant {
  id                String             @id @default(cuid())
  name              String
  status            String             @default("active")
  dataRetentionDays Int?
  deletionMode      TenantDeletionMode @default(SOFT_DELETE)
  createdAt         DateTime           @default(now())

  users         User[]
  members       TenantUser[]
  subscriptions TenantSubscription[]
  config        TenantConfig?
  tenantMode    TenantMode?
  systemMode    SystemMode?

  @@unique([name])
}

model TenantConfig {
  id                   String   @id @default(cuid())
  tenantId             String   @unique
  preset               String?
  scoring              Json
  explain              Json
  safety               Json
  llm                  Json?
  networkLearningOptIn Boolean  @default(false)
  networkLearning      Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model TenantUser {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId   String
  tenantId String
  role     String // e.g. 'ADMIN', 'RECRUITER', 'VIEWER'

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
}

model SubscriptionPlan {
  id        String   @id @default(cuid())
  name      String   @unique
  limits    Json
  createdAt DateTime @default(now())

  subscriptions TenantSubscription[]
}

model TenantSubscription {
  id        String           @id @default(cuid())
  tenant    Tenant           @relation(fields: [tenantId], references: [id])
  tenantId  String
  plan      SubscriptionPlan @relation(fields: [planId], references: [id])
  planId    String
  startAt   DateTime
  endAt     DateTime?
  isTrial   Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([tenantId])
  @@index([tenantId, startAt])
}

model SecurityEventLog {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, eventType])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  actorId   String?
  action    String // "MODE_CHANGED", "GUARDRAILS_UPDATED", "AGENT_FLAG_TOGGLED", "KILL_SWITCH_TOGGLED"
  meta      Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, action])
}

model UsageEvent {
  id         String         @id @default(cuid())
  tenantId   String         @default("default-tenant")
  eventType  UsageEventType
  count      Int            @default(1)
  metadata   Json?
  occurredAt DateTime       @default(now())
  createdAt  DateTime       @default(now())

  @@index([tenantId, occurredAt])
  @@index([tenantId, eventType, occurredAt])
}

model CostEvent {
  id         String         @id @default(cuid())
  tenantId   String?
  driver     CostDriverType
  value      Float
  unit       String
  sku        String?
  feature    String?
  metadata   Json?
  occurredAt DateTime       @default(now())
  createdAt  DateTime       @default(now())

  @@index([tenantId, occurredAt])
  @@index([driver, occurredAt])
}

model FeatureFlag {
  id          String   @id @default(cuid())
  tenantId    String   @default("default-tenant")
  name        String
  description String?
  enabled     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

model SystemMode {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  mode      String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model AgentFlag {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  agentName String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, agentName])
  @@index([tenantId])
}

model AgentKillSwitch {
  id        String    @id @default(cuid())
  agentName String    @unique
  latched   Boolean   @default(false)
  reason    String?
  latchedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model TenantMode {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  mode      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model AgentPrompt {
  id              String   @id @default(cuid())
  agentName       String
  version         String
  prompt          String
  active          Boolean  @default(false)
  rollbackVersion String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([agentName, version])
  @@index([agentName, active])
}

model Candidate {
  id                   String    @id @default(cuid())
  tenantId             String    @default("default-tenant")
  fullName             String
  email                String?
  phone                String?
  location             String?
  currentTitle         String?
  currentCompany       String?
  totalExperienceYears Int?
  seniorityLevel       String?
  summary              String?
  rawResumeText        String?
  sourceType           String?
  sourceTag            String?
  parsingConfidence    Float?
  trustScore           Int?
  status               String? // "Active", "Placed", etc.
  normalizedSkills     String[]
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?

  skills               CandidateSkill[]
  matches              Match[]
  candidateMatches     CandidateMatch[]
  matchResults         MatchResult[]
  jobCandidates        JobCandidate[]
  decisionItems        DecisionItem[]
  actionApprovals      AgentActionApproval[]
  outreachInteractions OutreachInteraction[]
  outreachActions      OutreachAction[]
  jobPostingMatches    JobPostingMatch[]
  hiringOutcomes       HiringOutcome[]
  hiringManagerFeedbacks HiringManagerFeedback[] @relation("CandidateFeedback")

  @@index([tenantId])
  @@index([tenantId, deletedAt])
}

model CandidateSkill {
  id                String    @id @default(cuid())
  tenantId          String    @default("default-tenant")
  candidate         Candidate @relation(fields: [candidateId], references: [id])
  candidateId       String
  name              String
  normalizedName    String
  proficiency       String? // "Low", "Medium", "High"
  yearsOfExperience Int?

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, normalizedName])
}

model Customer {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  name      String
  contact   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobReqs JobReq[]

  @@index([tenantId])
}

model JobReq {
  id             String    @id @default(cuid())
  tenantId       String    @default("default-tenant")
  customer       Customer? @relation(fields: [customerId], references: [id])
  customerId     String?
  title          String
  location       String?
  employmentType String?
  salaryMin      Int?
  salaryMax      Int?
  salaryCurrency String?
  salaryInterval String? // "year", "month", etc.
  seniorityLevel String?
  rawDescription String
  status         String? // "Open", "On Hold", "Closed"
  sourceType     String?
  sourceTag      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  skills               JobSkill[]
  matches              Match[]
  matchResults         MatchResult[]
  jobCandidates        JobCandidate[]
  decisionStreams      DecisionStream[]
  decisions            Decision[]
  actionApprovals      AgentActionApproval[]
  outreachInteractions OutreachInteraction[]
  outreachActions      OutreachAction[]
  hiringOutcomes       HiringOutcome[]
  jobIntent            JobIntent?
  hiringManagerBriefs  HiringManagerBrief[]
  hiringManagerFeedbacks HiringManagerFeedback[] @relation("JobReqFeedback")
  decisionArtifacts    DecisionArtifact[]

  @@index([tenantId])
  @@index([tenantId, customerId])
}

model JobIntent {
  id          String   @id @default(cuid())
  tenantId    String   @default("default-tenant")
  jobReq      JobReq   @relation(fields: [jobReqId], references: [id])
  jobReqId    String   @unique
  intent      Json
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  hiringManagerFeedbacks HiringManagerFeedback[] @relation("JobIntentFeedback")

  @@unique([tenantId, jobReqId])
  @@index([tenantId])
  @@index([tenantId, jobReqId])
}

model HiringManagerFeedback {
  id          String                       @id @default(cuid())
  tenantId    String                       @default("default-tenant")
  jobReq      JobReq                       @relation("JobReqFeedback", fields: [jobReqId], references: [id])
  jobReqId    String
  jobIntent   JobIntent?                   @relation("JobIntentFeedback", fields: [jobIntentId], references: [id])
  jobIntentId String?
  candidate   Candidate?                   @relation("CandidateFeedback", fields: [candidateId], references: [id])
  candidateId String?
  feedbackType HiringManagerFeedbackType
  status      HiringManagerFeedbackStatus  @default(SUBMITTED)
  payload     Json
  createdAt   DateTime                     @default(now())
  updatedAt   DateTime                     @updatedAt

  @@index([tenantId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobIntentId])
}

model JobSkill {
  id             String  @id @default(cuid())
  tenantId       String  @default("default-tenant")
  jobReq         JobReq  @relation(fields: [jobReqId], references: [id])
  jobReqId       String
  name           String
  normalizedName String
  required       Boolean @default(false)
  weight         Float?

  @@index([tenantId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, normalizedName])
}

model Match {
  id             String    @id @default(cuid())
  tenantId       String    @default("default-tenant")
  jobReq         JobReq    @relation(fields: [jobReqId], references: [id])
  jobReqId       String
  candidate      Candidate @relation(fields: [candidateId], references: [id])
  candidateId    String
  overallScore   Float
  category       String
  scoreBreakdown Json
  explanation    String
  redFlags       Json?
  status         String? // "Suggested", "Shortlisted", "Submitted", "Rejected"
  createdAt      DateTime  @default(now())
  createdByAgent String?
  deletedAt      DateTime?

  agentRun   AgentRunLog? @relation(fields: [agentRunId], references: [id])
  agentRunId String?

  jobCandidate    JobCandidate?         @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId  String?
  results         MatchResult[]
  histories       MatchHistory[]
  scoreComponents MatchScoreComponent[]

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, agentRunId])
  @@index([tenantId, jobCandidateId])
  @@index([tenantId, deletedAt])
}

model Job {
  id             String   @id @default(cuid())
  tenantId       String   @default("default-tenant")
  title          String
  description    String
  location       String?
  requiredSkills String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  matches CandidateMatch[]
}

model CandidateMatch {
  id                String   @id @default(cuid())
  tenantId          String   @default("default-tenant")
  jobId             String
  candidateId       String
  matchScore        Int
  confidence        Int
  explanation       Json
  confidenceReasons Json?
  shortlisted       Boolean  @default(false)
  shortlistReason   String?
  createdAt         DateTime @default(now())

  job       Job       @relation(fields: [jobId], references: [id])
  candidate Candidate @relation(fields: [candidateId], references: [id])

  @@index([tenantId, jobId])
  @@index([tenantId, candidateId])
}

model AgentRunLog {
  id               String         @id @default(cuid())
  tenantId         String         @default("default-tenant")
  agentName        String // "ETE-TS.RINA", etc.
  user             User?          @relation(fields: [userId], references: [id])
  userId           String?
  sourceType       String?
  sourceTag        String?
  input            Json
  retryPayload     Json?
  rawResumeText    String?
  output           Json?
  status           AgentRunStatus @default(RUNNING)
  errorMessage     String?
  durationMs       Int?
  inputSnapshot    Json
  outputSnapshot   Json?
  tokensPrompt     Int?
  tokensCompletion Int?
  startedAt        DateTime       @default(now())
  finishedAt       DateTime?
  retryCount       Int            @default(0)
  deletedAt        DateTime?

  retryOf   AgentRunLog?  @relation("AgentRunRetry", fields: [retryOfId], references: [id])
  retryOfId String?
  retries   AgentRunLog[] @relation("AgentRunRetry")

  matches              Match[]
  matchResults         MatchResult[]
  outreachInteractions OutreachInteraction[]

  @@index([tenantId])
  @@index([tenantId, agentName])
  @@index([tenantId, retryOfId])
  @@index([tenantId, deletedAt])
}

model AgentRun {
  id          String    @id @default(cuid())
  tenantId    String    @default("default-tenant")
  agentName   String
  requestedBy String?
  jobId       String?
  status      String    @default("running")
  promptMeta  Json?
  input       Json?
  output      Json?
  mode        String?
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?

  @@index([tenantId, agentName])
  @@index([tenantId, jobId])
}

model OutreachInteraction {
  id          String    @id @default(cuid())
  tenantId    String    @default("default-tenant")
  candidate   Candidate @relation(fields: [candidateId], references: [id])
  candidateId String

  jobReq   JobReq @relation(fields: [jobReqId], references: [id])
  jobReqId String

  agentRun   AgentRunLog? @relation(fields: [agentRunId], references: [id])
  agentRunId String?

  interactionType String   @default("OUTREACH_GENERATED")
  createdAt       DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, agentRunId])
}

model JobCandidate {
  id       String @id @default(cuid())
  tenantId String @default("default-tenant")
  jobReq   JobReq @relation(fields: [jobReqId], references: [id])
  jobReqId String

  candidate   Candidate @relation(fields: [candidateId], references: [id])
  candidateId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  status    JobCandidateStatus @default(POTENTIAL)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  confidenceScore     Float?
  confidenceBand      String?
  confidenceReasons   Json?
  confidenceNarrative String?
  confidenceSignals   Json?
  confidenceUpdatedAt DateTime?

  lastMatch         MatchResult?                @relation("JobCandidateLastMatch", fields: [lastMatchResultId], references: [id])
  lastMatchResultId String?                     @unique
  matchResults      MatchResult[]               @relation("JobCandidateMatchResults")
  matches           Match[]
  noteEntries       JobCandidateNote[]
  histories         JobCandidateHistory[]
  scoreHistory      JobCandidateScoreHistory[]
  steps             JobCandidateStep[]
  statusHistory     JobCandidateStatusHistory[]
  feedbackEntries   JobCandidateFeedback[]
  matchFeedback     MatchFeedback[]
  labels            JobCandidateLabel[]
  stages            JobCandidateStage[]

  notes String?

  @@index([tenantId, jobReqId])
  @@index([tenantId, candidateId])
}

model HiringManagerBrief {
  id        String                   @id @default(cuid())
  tenantId  String                   @default("default-tenant")
  jobReq    JobReq                   @relation(fields: [jobReqId], references: [id])
  jobReqId  String
  content   Json
  status    HiringManagerBriefStatus @default(DRAFT)
  createdBy String
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
  sentAt    DateTime?
  sentTo    String?

  @@index([tenantId])
  @@index([tenantId, jobReqId])
}

model DecisionArtifact {
  id              String                 @id @default(cuid())
  tenantId        String                 @default("default-tenant")
  job             JobReq?                @relation(fields: [jobId], references: [id])
  jobId           String?
  candidateIds    String[]               @default([])
  type            DecisionArtifactType
  status          DecisionArtifactStatus @default(DRAFT)
  payload         Json
  createdByUser   User                   @relation(fields: [createdByUserId], references: [id])
  createdByUserId String
  createdAt       DateTime               @default(now())
  publishedAt     DateTime?

  @@index([tenantId])
  @@index([tenantId, jobId])
  @@index([tenantId, status])
  @@index([tenantId, createdByUserId])
}

model DecisionStream {
  id            String    @id @default(cuid())
  tenantId      String    @default("default-tenant")
  job           JobReq    @relation(fields: [jobId], references: [id])
  jobId         String
  createdBy     String
  createdByUser User      @relation(fields: [createdBy], references: [id])
  status        String    @default("active") // "active" | "finalized"
  createdAt     DateTime  @default(now())
  finalizedAt   DateTime?

  items           DecisionItem[]
  actionApprovals AgentActionApproval[]

  @@index([tenantId])
  @@index([tenantId, jobId, createdBy, status])
}

model Decision {
  id           String          @id @default(cuid())
  tenantId     String          @default("default-tenant")
  job          JobReq          @relation(fields: [jobReqId], references: [id])
  jobReqId     String
  candidateIds String[]        @default([])
  payload      Json
  status       DecisionStatus  @default(DRAFT)
  createdBy    String
  publishedBy  String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  publishedAt  DateTime?

  @@index([tenantId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, jobReqId, status])
}

model DecisionReceipt {
  id              String                   @id @default(uuid())
  tenantId        String                   @default("default-tenant")
  firmId          String
  clientId        String?
  roleType        String
  agent           JudgmentAgent
  decisionType    JudgmentDecisionType
  signals         Json
  humanOverride   Json?
  outcome         Json?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@index([tenantId, firmId])
  @@index([tenantId, clientId])
  @@index([tenantId, roleType])
  @@index([tenantId, agent])
  @@index([tenantId, decisionType])
}

model JudgmentAggregate {
  id             String                      @id @default(cuid())
  tenantId       String                      @default("default-tenant")
  dimension      JudgmentAggregateDimension
  dimensionValue String
  windowStart    DateTime
  windowEnd      DateTime
  metric         String
  value          Json
  sampleSize     Int
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt

  @@index([tenantId])
  @@index([tenantId, dimension, dimensionValue])
  @@index([tenantId, windowStart, windowEnd])
  @@index([tenantId, metric])
}

model DecisionItem {
  id               String         @id @default(cuid())
  tenantId         String         @default("default-tenant")
  decisionStream   DecisionStream @relation(fields: [decisionStreamId], references: [id])
  decisionStreamId String
  candidate        Candidate      @relation(fields: [candidateId], references: [id])
  candidateId      String
  action           String // "viewed" | "shortlisted" | "removed" | "favorited"
  createdAt        DateTime       @default(now())

  @@index([tenantId, decisionStreamId])
  @@index([tenantId, candidateId])
}

model ApprovalRequest {
  id             String         @id @default(cuid())
  tenantId       String         @default("default-tenant")
  actionType     String
  actionPayload  Json
  payloadHash    String
  requestedBy    String
  requestedAt    DateTime       @default(now())
  status         ApprovalStatus @default(PENDING)
  approvedBy     String?
  approvedAt     DateTime?
  expiresAt      DateTime?
  decisionReason String?

  actionApproval AgentActionApproval?

  @@index([tenantId, status])
  @@index([tenantId, requestedBy])
}

model AgentActionApproval {
  id               String           @id @default(cuid())
  tenantId         String           @default("default-tenant")
  jobReq           JobReq?          @relation(fields: [jobReqId], references: [id])
  jobReqId         String?
  candidate        Candidate?       @relation(fields: [candidateId], references: [id])
  candidateId      String?
  actionType       ActionType
  actionPayload    Json
  proposedBy       String
  proposedAt       DateTime         @default(now())
  status           ApprovalStatus   @default(PENDING)
  decidedBy        String?
  decidedAt        DateTime?
  decisionReason   String?
  expiresAt        DateTime?
  decisionStream   DecisionStream?  @relation(fields: [decisionStreamId], references: [id])
  decisionStreamId String?
  executionStatus  ExecutionStatus?
  executedAt       DateTime?
  executionResult  Json?
  approvalRequest  ApprovalRequest? @relation(fields: [approvalRequestId], references: [id])
  approvalRequestId String? @unique

  @@index([tenantId, status])
  @@index([tenantId, jobReqId])
  @@index([tenantId, candidateId])
  @@index([tenantId, approvalRequestId])
}

model MatchResult {
  id                       String          @id @default(cuid())
  tenantId                 String          @default("default-tenant")
  candidate                Candidate       @relation(fields: [candidateId], references: [id])
  candidateId              String
  jobReq                   JobReq          @relation(fields: [jobReqId], references: [id])
  jobReqId                 String
  score                    Int
  reasons                  Json?
  createdAt                DateTime        @default(now())
  skillScore               Int?
  seniorityScore           Int?
  locationScore            Int?
  agentRun                 AgentRunLog?    @relation(fields: [agentRunId], references: [id])
  agentRunId               String?
  candidateSignalScore     Int?
  candidateSignalBreakdown Json?
  shortlisted              Boolean         @default(false)
  shortlistReason          String?
  feedbackEntries          MatchFeedback[]

  jobCandidate   JobCandidate? @relation("JobCandidateMatchResults", fields: [jobCandidateId], references: [id])
  jobCandidateId String?
  lastMatchFor   JobCandidate? @relation("JobCandidateLastMatch")
  Match          Match?        @relation(fields: [matchId], references: [id])
  matchId        String?

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, jobCandidateId])
  @@index([tenantId, agentRunId])
}

model JobCandidateNote {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  author         User?        @relation(fields: [authorId], references: [id])
  authorId       String?
  content        String
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model MatchHistory {
  id            String   @id @default(cuid())
  tenantId      String   @default("default-tenant")
  match         Match    @relation(fields: [matchId], references: [id])
  matchId       String
  action        String
  changes       Json
  performedBy   User?    @relation(fields: [performedById], references: [id])
  performedById String?
  createdAt     DateTime @default(now())

  @@index([tenantId, matchId])
}

model JobCandidateHistory {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  action         String
  changes        Json
  performedBy    User?        @relation(fields: [performedById], references: [id])
  performedById  String?
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model JobCandidateScoreHistory {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  score          Float
  reason         String?
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model JobCandidateStep {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  step           String
  status         String // e.g., "Pending", "Completed"
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model JobCandidateStatusHistory {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  status         String
  changedAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model JobCandidateFeedback {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  feedbackText   String
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model MatchFeedback {
  id                   String        @id @default(cuid())
  tenantId             String        @default("default-tenant")
  matchResult          MatchResult   @relation(fields: [matchResultId], references: [id])
  matchResultId        String
  jobReqId             String
  candidateId          String
  jobCandidate         JobCandidate? @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId       String?
  user                 User          @relation(fields: [userId], references: [id])
  userId               String
  feedback             String
  direction            String?
  outcome              String
  outcomeSource        String?
  matchScore           Int?
  confidenceScore      Int?
  shortlistStrategy    String?
  matchSignals         Json?
  guardrailsPreset     String?
  guardrailsConfig     Json?
  guardrailsConfigHash String?
  systemMode           String?
  createdAt            DateTime      @default(now())

  @@unique([tenantId, jobReqId, candidateId, userId])
  @@unique([tenantId, matchResultId, outcome])
  @@index([tenantId, matchResultId])
  @@index([tenantId, jobReqId])
}

model MatchQualitySnapshot {
  id         String   @id @default(cuid())
  tenantId   String   @default("default-tenant")
  scope      String
  scopeRef   String?
  windowDays Int
  mqi        Float
  components Json
  capturedAt DateTime @default(now())

  @@index([tenantId, scope, capturedAt])
  @@index([tenantId, scopeRef])
}

model JobCandidateLabel {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  label          String
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
  @@index([tenantId, label])
}

model JobCandidateStage {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  stage          String
  enteredAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model HiringOutcome {
  id                String    @id @default(cuid())
  tenantId          String    @default("default-tenant")
  job               JobReq    @relation(fields: [jobId], references: [id])
  jobId             String
  candidate         Candidate @relation(fields: [candidateId], references: [id])
  candidateId       String
  candidateIdString String?
  status            String
  source            String
  createdAt         DateTime  @default(now())

  @@unique([tenantId, jobId, candidateId])
  @@index([tenantId, jobId])
  @@index([tenantId, candidateId])
}

model OutreachAction {
  id         String   @id @default(cuid())
  tenantId   String   @default("default-tenant")
  actionType String
  status     String
  metadata   Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  candidate   Candidate? @relation(fields: [candidateId], references: [id])
  candidateId String?

  jobReq   JobReq? @relation(fields: [jobReqId], references: [id])
  jobReqId String?

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
}

model TransactionLog {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  source    String
  status    String
  details   Json
  createdAt DateTime @default(now())

  @@index([tenantId])
}

model JobPosting {
  id          String   @id @default(cuid())
  tenantId    String   @default("default-tenant")
  title       String
  description String
  location    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  matches JobPostingMatch[]

  @@index([tenantId])
}

model JobPostingMatch {
  id           String     @id @default(cuid())
  tenantId     String     @default("default-tenant")
  jobPosting   JobPosting @relation(fields: [jobPostingId], references: [id])
  jobPostingId String
  candidate    Candidate  @relation(fields: [candidateId], references: [id])
  candidateId  String
  score        Float
  createdAt    DateTime   @default(now())

  @@index([tenantId, jobPostingId])
  @@index([tenantId, candidateId])
}

model MatchScoreComponent {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  match     Match    @relation(fields: [matchId], references: [id])
  matchId   String
  component String
  score     Float
  createdAt DateTime @default(now())

  @@index([tenantId, matchId])
}

model MetricEvent {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  eventType String
  entityId  String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, eventType])
  @@index([createdAt])
}

model AsyncJobState {
  id        String    @id @default(cuid())
  jobName   String    @unique
  jobType   String
  status    String    @default("idle")
  retries   Int       @default(0)
  lastError String?
  lastRunAt DateTime?
  nextRunAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([jobType])
  @@index([status])
  @@index([nextRunAt])
}

model TenantLearningSignal {
  id         String   @id @default(cuid())
  tenantId   String   @default("default-tenant")
  roleFamily String
  industry   String?
  region     String?
  signalType String
  value      Float
  sampleSize Int
  windowDays Int
  capturedAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, signalType])
  @@index([capturedAt])
}

model LearningAggregate {
  id         String   @id @default(cuid())
  roleFamily String
  industry   String?
  region     String?
  signalType String
  value      Float
  sampleSize Int
  windowDays Int
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([signalType, windowDays])
  @@index([roleFamily, industry, region])
}

model EteIndexSnapshot {
  id         String   @id @default(cuid())
  period     String   @unique // "2026-Q1"
  value      Float
  components Json
  createdAt  DateTime @default(now())
}

model BenchmarkRelease {
  id          String    @id @default(cuid())
  version     String
  status      String    @default("draft")
  windowDays  Int
  createdAt   DateTime  @default(now())
  publishedAt DateTime?

  metrics BenchmarkMetric[]
}

model BenchmarkMetric {
  id               String   @id @default(cuid())
  releaseId        String
  roleFamily       String
  industry         String?
  region           String?
  metricKey        String
  metricValue      Float
  sampleSize       Int
  methodologyNotes String?
  createdAt        DateTime @default(now())

  release BenchmarkRelease @relation(fields: [releaseId], references: [id])

  @@index([releaseId])
  @@index([releaseId, roleFamily, metricKey])
}

model InsightSnapshot {
  id          String    @id @default(cuid())
  releaseId   String
  title       String
  subtitle    String?
  audience    String // "internal" | "client" | "public"
  status      String // "draft" | "approved" | "published"
  contentJson Json
  createdAt   DateTime  @default(now())
  publishedAt DateTime?

  @@index([releaseId])
  @@index([status])
}

model CopilotAudit {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  query     String
  response  Json
  evidence  Json
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, createdAt])
}
