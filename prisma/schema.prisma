datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum TenantDeletionMode {
  SOFT_DELETE
  HARD_DELETE
}

enum AgentRunStatus {
  RUNNING
  SUCCESS
  FAILED
  PARTIAL
}

enum JobCandidateStatus {
  POTENTIAL // AI suggests
  SHORTLISTED // recruiter likes
  SUBMITTED // sent to client
  INTERVIEWING
  HIRED
  REJECTED
}

model User {
  id          String   @id @default(cuid())
  tenantId    String   @default("default-tenant")
  email       String
  displayName String
  role        String // "Recruiter", "Sourcer", "Sales", "Admin"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  agentRuns     AgentRunLog[]
  jobCandidates JobCandidate[]
  identities    UserIdentity[]
  securityEvents SecurityEventLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model UserIdentity {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  provider  String
  subject   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, subject])
  @@index([userId])
}

model Tenant {
  id                String             @id @default(cuid())
  name              String
  status            String             @default("active")
  dataRetentionDays Int?
  deletionMode      TenantDeletionMode @default(SOFT_DELETE)
  createdAt         DateTime           @default(now())

  users         User[]
  subscriptions TenantSubscription[]

  @@unique([name])
}

model SubscriptionPlan {
  id        String   @id @default(cuid())
  name      String   @unique
  limits    Json
  createdAt DateTime @default(now())

  subscriptions TenantSubscription[]
}

model TenantSubscription {
  id        String           @id @default(cuid())
  tenant    Tenant           @relation(fields: [tenantId], references: [id])
  tenantId  String
  plan      SubscriptionPlan @relation(fields: [planId], references: [id])
  planId    String
  startAt   DateTime
  endAt     DateTime?
  isTrial   Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([tenantId])
  @@index([tenantId, startAt])
}

model SecurityEventLog {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, eventType])
}

model FeatureFlag {
  id          String   @id @default(cuid())
  tenantId    String   @default("default-tenant")
  name        String
  description String?
  enabled     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

model AgentPrompt {
  id              String   @id @default(cuid())
  agentName       String
  version         String
  prompt          String
  active          Boolean  @default(false)
  rollbackVersion String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([agentName, version])
  @@index([agentName, active])
}

model Candidate {
  id                   String   @id @default(cuid())
  tenantId             String   @default("default-tenant")
  fullName             String
  email                String?
  phone                String?
  location             String?
  currentTitle         String?
  currentCompany       String?
  totalExperienceYears Int?
  seniorityLevel       String?
  summary              String?
  rawResumeText        String?
  sourceType           String?
  sourceTag            String?
  parsingConfidence    Float?
  status               String? // "Active", "Placed", etc.
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  deletedAt            DateTime?

  skills               CandidateSkill[]
  matches              Match[]
  matchResults         MatchResult[]
  jobCandidates        JobCandidate[]
  outreachInteractions OutreachInteraction[]

  @@index([tenantId])
  @@index([tenantId, deletedAt])
}

model CandidateSkill {
  id                String    @id @default(cuid())
  tenantId          String    @default("default-tenant")
  candidate         Candidate @relation(fields: [candidateId], references: [id])
  candidateId       String
  name              String
  normalizedName    String
  proficiency       String? // "Low", "Medium", "High"
  yearsOfExperience Int?

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, normalizedName])
}

model Customer {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  name      String
  contact   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobReqs JobReq[]

  @@index([tenantId])
}

model JobReq {
  id             String    @id @default(cuid())
  tenantId       String    @default("default-tenant")
  customer       Customer? @relation(fields: [customerId], references: [id])
  customerId     String?
  title          String
  location       String?
  employmentType String?
  salaryMin      Int?
  salaryMax      Int?
  salaryCurrency String?
  salaryInterval String? // "year", "month", etc.
  seniorityLevel String?
  rawDescription String
  status         String? // "Open", "On Hold", "Closed"
  sourceType     String?
  sourceTag      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  skills               JobSkill[]
  matches              Match[]
  matchResults         MatchResult[]
  jobCandidates        JobCandidate[]
  outreachInteractions OutreachInteraction[]

  @@index([tenantId])
  @@index([tenantId, customerId])
}

model JobSkill {
  id             String  @id @default(cuid())
  tenantId       String  @default("default-tenant")
  jobReq         JobReq  @relation(fields: [jobReqId], references: [id])
  jobReqId       String
  name           String
  normalizedName String
  required       Boolean @default(false)
  weight         Float?

  @@index([tenantId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, normalizedName])
}

model Match {
  id             String    @id @default(cuid())
  tenantId       String    @default("default-tenant")
  jobReq         JobReq    @relation(fields: [jobReqId], references: [id])
  jobReqId       String
  candidate      Candidate @relation(fields: [candidateId], references: [id])
  candidateId    String
  overallScore   Float
  category       String
  scoreBreakdown Json
  explanation    String
  redFlags       Json?
  status         String? // "Suggested", "Shortlisted", "Submitted", "Rejected"
  createdAt      DateTime  @default(now())
  createdByAgent String?
  deletedAt      DateTime?

  @@index([tenantId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, candidateId])
  @@index([tenantId, deletedAt])
}

model MatchResult {
  id          String    @id @default(cuid())
  tenantId    String    @default("default-tenant")
  candidate   Candidate @relation(fields: [candidateId], references: [id])
  candidateId String

  jobReq   JobReq @relation(fields: [jobReqId], references: [id])
  jobReqId String

  jobCandidate   JobCandidate? @relation("JobCandidateMatchResults", fields: [jobCandidateId], references: [id])
  jobCandidateId String?

  score     Int
  reasons   Json?
  createdAt DateTime @default(now())
  deletedAt DateTime?

  skillScore               Int?
  seniorityScore           Int?
  locationScore            Int?
  candidateSignalScore     Int?
  candidateSignalBreakdown Json?

  agentRun   AgentRunLog? @relation(fields: [agentRunId], references: [id])
  agentRunId String?

  lastMatchFor JobCandidate? @relation("JobCandidateLastMatch")

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, agentRunId])
  @@index([tenantId, jobCandidateId])
  @@index([tenantId, deletedAt])
}

model AgentRunLog {
  id               String         @id @default(cuid())
  tenantId         String         @default("default-tenant")
  agentName        String // "EAT-TS.RINA", etc.
  user             User?          @relation(fields: [userId], references: [id])
  userId           String?
  sourceType       String?
  sourceTag        String?
  input            Json
  output           Json?
  status           AgentRunStatus @default(RUNNING)
  errorMessage     String?
  durationMs       Int?
  inputSnapshot    Json
  outputSnapshot   Json?
  tokensPrompt     Int?
  tokensCompletion Int?
  startedAt        DateTime       @default(now())
  finishedAt       DateTime?
  retryCount       Int            @default(0)
  deletedAt        DateTime?

  retryOf   AgentRunLog?  @relation("AgentRunRetry", fields: [retryOfId], references: [id])
  retryOfId String?
  retries   AgentRunLog[] @relation("AgentRunRetry")

  matchResults         MatchResult[]
  outreachInteractions OutreachInteraction[]

  @@index([tenantId])
  @@index([tenantId, agentName])
  @@index([tenantId, retryOfId])
  @@index([tenantId, deletedAt])
}

model OutreachInteraction {
  id          String    @id @default(cuid())
  tenantId    String    @default("default-tenant")
  candidate   Candidate @relation(fields: [candidateId], references: [id])
  candidateId String

  jobReq   JobReq @relation(fields: [jobReqId], references: [id])
  jobReqId String

  agentRun   AgentRunLog? @relation(fields: [agentRunId], references: [id])
  agentRunId String?

  interactionType String   @default("OUTREACH_GENERATED")
  createdAt       DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, agentRunId])
}

model JobCandidate {
  id       String @id @default(cuid())
  tenantId String @default("default-tenant")
  jobReq   JobReq @relation(fields: [jobReqId], references: [id])
  jobReqId String

  candidate   Candidate @relation(fields: [candidateId], references: [id])
  candidateId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  status    JobCandidateStatus @default(POTENTIAL)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  lastMatch         MatchResult?  @relation("JobCandidateLastMatch", fields: [lastMatchResultId], references: [id])
  lastMatchResultId String?       @unique
  matchResults      MatchResult[] @relation("JobCandidateMatchResults")

  notes String?

  @@unique([tenantId, jobReqId, candidateId])
  @@index([tenantId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, candidateId])
  @@index([tenantId, userId])
  @@index([tenantId, lastMatchResultId])
}

model CoverageReport {
  id              String   @id @default(cuid())
  branch          String   @default("main")
  commitSha       String?
  coveragePercent Float
  createdAt       DateTime @default(now())

  @@index([branch, createdAt])
}
