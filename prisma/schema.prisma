datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum AgentRunStatus {
  RUNNING
  SUCCESS
  FAILED
  PARTIAL
}

enum JobCandidateStatus {
  POTENTIAL   // AI suggests
  SHORTLISTED // recruiter likes
  SUBMITTED   // sent to client
  INTERVIEWING
  HIRED
  REJECTED
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  displayName String
  role        String   // "Recruiter", "Sourcer", "Sales", "Admin"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  agentRuns     AgentRunLog[]
  jobCandidates JobCandidate[]
}

model Candidate {
  id                   String             @id @default(cuid())
  fullName             String
  email                String?
  phone                String?
  location             String?
  currentTitle         String?
  currentCompany       String?
  totalExperienceYears Int?
  seniorityLevel       String?
  summary              String?
  rawResumeText        String?
  sourceType           String?
  sourceTag            String?
  parsingConfidence    Float?
  status               String?            // "Active", "Placed", etc.
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  skills   CandidateSkill[]
  matches  Match[]
  matchResults MatchResult[]
  jobCandidates JobCandidate[]
}

model CandidateSkill {
  id                String    @id @default(cuid())
  candidate         Candidate @relation(fields: [candidateId], references: [id])
  candidateId       String
  name              String
  normalizedName    String
  proficiency       String?   // "Low", "Medium", "High"
  yearsOfExperience Int?

  @@index([candidateId])
  @@index([normalizedName])
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  contact   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobReqs JobReq[]
}

model JobReq {
  id               String    @id @default(cuid())
  customer         Customer? @relation(fields: [customerId], references: [id])
  customerId       String?
  title            String
  location         String?
  employmentType   String?
  salaryMin        Int?
  salaryMax        Int?
  salaryCurrency   String?
  salaryInterval   String?   // "year", "month", etc.
  seniorityLevel   String?
  rawDescription   String
  status           String?   // "Open", "On Hold", "Closed"
  sourceType       String?
  sourceTag        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  skills  JobSkill[]
  matches Match[]
  matchResults MatchResult[]
  jobCandidates JobCandidate[]
}

model JobSkill {
  id             String  @id @default(cuid())
  jobReq         JobReq  @relation(fields: [jobReqId], references: [id])
  jobReqId       String
  name           String
  normalizedName String
  required       Boolean @default(false)
  weight         Float?

  @@index([jobReqId])
  @@index([normalizedName])
}

model Match {
  id             String     @id @default(cuid())
  jobReq         JobReq     @relation(fields: [jobReqId], references: [id])
  jobReqId       String
  candidate      Candidate  @relation(fields: [candidateId], references: [id])
  candidateId    String
  overallScore   Float
  category       String
  scoreBreakdown Json
  explanation    String
  redFlags       Json?
  status         String?    // "Suggested", "Shortlisted", "Submitted", "Rejected"
  createdAt      DateTime   @default(now())
  createdByAgent String?

  @@index([jobReqId])
  @@index([candidateId])
}

model MatchResult {
  id              String        @id @default(cuid())
  candidate       Candidate     @relation(fields: [candidateId], references: [id])
  candidateId     String

  jobReq          JobReq        @relation(fields: [jobReqId], references: [id])
  jobReqId        String

  jobCandidate    JobCandidate? @relation("JobCandidateMatchResults", fields: [jobCandidateId], references: [id])
  jobCandidateId  String?

  score           Int
  reasons         Json?
  createdAt       DateTime      @default(now())

  skillScore      Int?
  seniorityScore  Int?
  locationScore   Int?

  agentRun        AgentRunLog?  @relation(fields: [agentRunId], references: [id])
  agentRunId      String?

  lastMatchFor    JobCandidate? @relation("JobCandidateLastMatch")

  @@index([candidateId])
  @@index([jobReqId])
  @@index([agentRunId])
  @@index([jobCandidateId])
}

model AgentRunLog {
  id               String   @id @default(cuid())
  agentName        String   // "EAT-TS.RINA", etc.
  user             User?    @relation(fields: [userId], references: [id])
  userId           String?
  sourceType       String?
  sourceTag        String?
  input            Json
  output           Json?
  status           AgentRunStatus @default(RUNNING)
  errorMessage     String?
  durationMs       Int?
  inputSnapshot    Json
  outputSnapshot   Json?
  tokensPrompt     Int?
  tokensCompletion Int?
  startedAt        DateTime @default(now())
  finishedAt       DateTime?
  retryCount       Int      @default(0)

  retryOf    AgentRunLog? @relation("AgentRunRetry", fields: [retryOfId], references: [id])
  retryOfId String?
  retries   AgentRunLog[] @relation("AgentRunRetry")

  matchResults     MatchResult[]

  @@index([agentName])
  @@index([retryOfId])
}

model JobCandidate {
  id                String             @id @default(cuid())
  jobReq            JobReq             @relation(fields: [jobReqId], references: [id])
  jobReqId          String

  candidate         Candidate          @relation(fields: [candidateId], references: [id])
  candidateId       String

  user    User?   @relation(fields: [userId], references: [id])
  userId  String?

  status            JobCandidateStatus @default(POTENTIAL)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  lastMatch         MatchResult?       @relation("JobCandidateLastMatch", fields: [lastMatchResultId], references: [id])
  lastMatchResultId String?            @unique
  matchResults      MatchResult[]      @relation("JobCandidateMatchResults")

  notes             String?

  @@index([jobReqId])
  @@index([candidateId])
  @@index([userId])
  @@index([lastMatchResultId])
  @@unique([jobReqId, candidateId])
}
