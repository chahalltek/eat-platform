datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UsageEventType {
  JOBS_PROCESSED
  CANDIDATES_EVALUATED
  AGENT_RUN
  EXPLAIN_CALL
  COPILOT_CALL
}

enum TenantDeletionMode {
  SOFT_DELETE
  HARD_DELETE
}

enum AgentRunStatus {
  RUNNING
  SUCCESS
  FAILED
  PARTIAL
}

enum JobCandidateStatus {
  POTENTIAL // AI suggests
  SHORTLISTED // recruiter likes
  SUBMITTED // sent to client
  INTERVIEWING
  HIRED
  REJECTED
}

model User {
  id          String   @id @default(cuid())
  tenantId    String   @default("default-tenant")
  email       String
  displayName String
  role        String // "Recruiter", "Sourcer", "Sales", "Admin"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant            Tenant       @relation(fields: [tenantId], references: [id])
  tenantMemberships TenantUser[]

  agentRuns             AgentRunLog[]
  jobCandidates         JobCandidate[]
  decisionStreams       DecisionStream[]
  identities            UserIdentity[]
  securityEvents        SecurityEventLog[]
  matchHistories        MatchHistory[]
  jobCandidateNotes     JobCandidateNote[]
  jobCandidateHistories JobCandidateHistory[]
  matchFeedback         MatchFeedback[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model UserIdentity {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  provider  String
  subject   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, subject])
  @@index([userId])
}

model Tenant {
  id                String             @id @default(cuid())
  name              String
  status            String             @default("active")
  dataRetentionDays Int?
  deletionMode      TenantDeletionMode @default(SOFT_DELETE)
  createdAt         DateTime           @default(now())

  users         User[]
  members       TenantUser[]
  subscriptions TenantSubscription[]
  config        TenantConfig?
  tenantMode    TenantMode?
  systemMode    SystemMode?

  @@unique([name])
}

model TenantConfig {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  preset    String?
  scoring   Json
  explain   Json
  safety    Json
  llm       Json?
  networkLearningOptIn Boolean @default(false)
  networkLearning Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model TenantUser {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId   String
  tenantId String
  role     String // e.g. 'ADMIN', 'RECRUITER', 'VIEWER'

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
}

model SubscriptionPlan {
  id        String   @id @default(cuid())
  name      String   @unique
  limits    Json
  createdAt DateTime @default(now())

  subscriptions TenantSubscription[]
}

model TenantSubscription {
  id        String           @id @default(cuid())
  tenant    Tenant           @relation(fields: [tenantId], references: [id])
  tenantId  String
  plan      SubscriptionPlan @relation(fields: [planId], references: [id])
  planId    String
  startAt   DateTime
  endAt     DateTime?
  isTrial   Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([tenantId])
  @@index([tenantId, startAt])
}

model SecurityEventLog {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  eventType String
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, eventType])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  actorId   String?
  action    String // "MODE_CHANGED", "GUARDRAILS_UPDATED", "AGENT_FLAG_TOGGLED"
  meta      Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, action])
}

model UsageEvent {
  id         String         @id @default(cuid())
  tenantId   String         @default("default-tenant")
  eventType  UsageEventType
  count      Int            @default(1)
  metadata   Json?
  occurredAt DateTime       @default(now())
  createdAt  DateTime       @default(now())

  @@index([tenantId, occurredAt])
  @@index([tenantId, eventType, occurredAt])
}

model FeatureFlag {
  id          String   @id @default(cuid())
  tenantId    String   @default("default-tenant")
  name        String
  description String?
  enabled     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
}

model SystemMode {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  mode      String
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model AgentFlag {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  agentName String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, agentName])
  @@index([tenantId])
}

model AgentKillSwitch {
  id        String    @id @default(cuid())
  agentName String    @unique
  latched   Boolean   @default(false)
  reason    String?
  latchedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model TenantMode {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  mode      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model AgentPrompt {
  id              String   @id @default(cuid())
  agentName       String
  version         String
  prompt          String
  active          Boolean  @default(false)
  rollbackVersion String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([agentName, version])
  @@index([agentName, active])
}

model Candidate {
  id                   String    @id @default(cuid())
  tenantId             String    @default("default-tenant")
  fullName             String
  email                String?
  phone                String?
  location             String?
  currentTitle         String?
  currentCompany       String?
  totalExperienceYears Int?
  seniorityLevel       String?
  summary              String?
  rawResumeText        String?
  sourceType           String?
  sourceTag            String?
  parsingConfidence    Float?
  trustScore           Int?
  status               String? // "Active", "Placed", etc.
  normalizedSkills     String[]
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deletedAt            DateTime?

  skills               CandidateSkill[]
  matches              Match[]
  candidateMatches     CandidateMatch[]
  matchResults         MatchResult[]
  jobCandidates        JobCandidate[]
  decisionItems        DecisionItem[]
  outreachInteractions OutreachInteraction[]
  outreachActions      OutreachAction[]
  jobPostingMatches    JobPostingMatch[]
  hiringOutcomes       HiringOutcome[]

  @@index([tenantId])
  @@index([tenantId, deletedAt])
}

model CandidateSkill {
  id                String    @id @default(cuid())
  tenantId          String    @default("default-tenant")
  candidate         Candidate @relation(fields: [candidateId], references: [id])
  candidateId       String
  name              String
  normalizedName    String
  proficiency       String? // "Low", "Medium", "High"
  yearsOfExperience Int?

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, normalizedName])
}

model Customer {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  name      String
  contact   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobReqs JobReq[]

  @@index([tenantId])
}

model JobReq {
  id             String    @id @default(cuid())
  tenantId       String    @default("default-tenant")
  customer       Customer? @relation(fields: [customerId], references: [id])
  customerId     String?
  title          String
  location       String?
  employmentType String?
  salaryMin      Int?
  salaryMax      Int?
  salaryCurrency String?
  salaryInterval String? // "year", "month", etc.
  seniorityLevel String?
  rawDescription String
  status         String? // "Open", "On Hold", "Closed"
  sourceType     String?
  sourceTag      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  skills               JobSkill[]
  matches              Match[]
  matchResults         MatchResult[]
  jobCandidates        JobCandidate[]
  decisionStreams      DecisionStream[]
  outreachInteractions OutreachInteraction[]
  outreachActions      OutreachAction[]
  hiringOutcomes       HiringOutcome[]

  @@index([tenantId])
  @@index([tenantId, customerId])
}

model JobSkill {
  id             String  @id @default(cuid())
  tenantId       String  @default("default-tenant")
  jobReq         JobReq  @relation(fields: [jobReqId], references: [id])
  jobReqId       String
  name           String
  normalizedName String
  required       Boolean @default(false)
  weight         Float?

  @@index([tenantId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, normalizedName])
}

model Match {
  id             String    @id @default(cuid())
  tenantId       String    @default("default-tenant")
  jobReq         JobReq    @relation(fields: [jobReqId], references: [id])
  jobReqId       String
  candidate      Candidate @relation(fields: [candidateId], references: [id])
  candidateId    String
  overallScore   Float
  category       String
  scoreBreakdown Json
  explanation    String
  redFlags       Json?
  status         String? // "Suggested", "Shortlisted", "Submitted", "Rejected"
  createdAt      DateTime  @default(now())
  createdByAgent String?
  deletedAt      DateTime?

  agentRun   AgentRunLog? @relation(fields: [agentRunId], references: [id])
  agentRunId String?

  jobCandidate    JobCandidate?         @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId  String?
  results         MatchResult[]
  histories       MatchHistory[]
  scoreComponents MatchScoreComponent[]

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, agentRunId])
  @@index([tenantId, jobCandidateId])
  @@index([tenantId, deletedAt])
}

model Job {
  id             String   @id @default(cuid())
  tenantId       String   @default("default-tenant")
  title          String
  description    String
  location       String?
  requiredSkills String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  matches CandidateMatch[]
}

model CandidateMatch {
  id                String   @id @default(cuid())
  tenantId          String   @default("default-tenant")
  jobId             String
  candidateId       String
  matchScore        Int
  confidence        Int
  explanation       Json
  confidenceReasons Json?
  shortlisted       Boolean  @default(false)
  shortlistReason   String?
  createdAt         DateTime @default(now())

  job       Job       @relation(fields: [jobId], references: [id])
  candidate Candidate @relation(fields: [candidateId], references: [id])

  @@index([tenantId, jobId])
  @@index([tenantId, candidateId])
}

model AgentRunLog {
  id               String         @id @default(cuid())
  tenantId         String         @default("default-tenant")
  agentName        String // "ETE-TS.RINA", etc.
  user             User?          @relation(fields: [userId], references: [id])
  userId           String?
  sourceType       String?
  sourceTag        String?
  input            Json
  retryPayload     Json?
  rawResumeText    String?
  output           Json?
  status           AgentRunStatus @default(RUNNING)
  errorMessage     String?
  durationMs       Int?
  inputSnapshot    Json
  outputSnapshot   Json?
  tokensPrompt     Int?
  tokensCompletion Int?
  startedAt        DateTime       @default(now())
  finishedAt       DateTime?
  retryCount       Int            @default(0)
  deletedAt        DateTime?

  retryOf   AgentRunLog?  @relation("AgentRunRetry", fields: [retryOfId], references: [id])
  retryOfId String?
  retries   AgentRunLog[] @relation("AgentRunRetry")

  matches              Match[]
  matchResults         MatchResult[]
  outreachInteractions OutreachInteraction[]

  @@index([tenantId])
  @@index([tenantId, agentName])
  @@index([tenantId, retryOfId])
  @@index([tenantId, deletedAt])
}

model AgentRun {
  id          String    @id @default(cuid())
  tenantId    String    @default("default-tenant")
  agentName   String
  requestedBy String?
  jobId       String?
  status      String    @default("running")
  promptMeta  Json?
  input       Json?
  output      Json?
  mode        String?
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?

  @@index([tenantId, agentName])
  @@index([tenantId, jobId])
}

model OutreachInteraction {
  id          String    @id @default(cuid())
  tenantId    String    @default("default-tenant")
  candidate   Candidate @relation(fields: [candidateId], references: [id])
  candidateId String

  jobReq   JobReq @relation(fields: [jobReqId], references: [id])
  jobReqId String

  agentRun   AgentRunLog? @relation(fields: [agentRunId], references: [id])
  agentRunId String?

  interactionType String   @default("OUTREACH_GENERATED")
  createdAt       DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, agentRunId])
}

model JobCandidate {
  id       String @id @default(cuid())
  tenantId String @default("default-tenant")
  jobReq   JobReq @relation(fields: [jobReqId], references: [id])
  jobReqId String

  candidate   Candidate @relation(fields: [candidateId], references: [id])
  candidateId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  status    JobCandidateStatus @default(POTENTIAL)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  lastMatch         MatchResult?                @relation("JobCandidateLastMatch", fields: [lastMatchResultId], references: [id])
  lastMatchResultId String?                     @unique
  matchResults      MatchResult[]               @relation("JobCandidateMatchResults")
  matches           Match[]
  noteEntries       JobCandidateNote[]
  histories         JobCandidateHistory[]
  scoreHistory      JobCandidateScoreHistory[]
  steps             JobCandidateStep[]
  statusHistory     JobCandidateStatusHistory[]
  feedbackEntries   JobCandidateFeedback[]
  matchFeedback     MatchFeedback[]
  labels            JobCandidateLabel[]
  stages            JobCandidateStage[]

  notes String?

  @@index([tenantId, jobReqId])
  @@index([tenantId, candidateId])
}

model DecisionStream {
  id            String    @id @default(cuid())
  tenantId      String    @default("default-tenant")
  job           JobReq    @relation(fields: [jobId], references: [id])
  jobId         String
  createdBy     String
  createdByUser User      @relation(fields: [createdBy], references: [id])
  status        String    @default("active") // "active" | "finalized"
  createdAt     DateTime  @default(now())
  finalizedAt   DateTime?

  items DecisionItem[]

  @@index([tenantId])
  @@index([tenantId, jobId, createdBy, status])
}

model DecisionItem {
  id               String         @id @default(cuid())
  tenantId         String         @default("default-tenant")
  decisionStream   DecisionStream @relation(fields: [decisionStreamId], references: [id])
  decisionStreamId String
  candidate        Candidate      @relation(fields: [candidateId], references: [id])
  candidateId      String
  action           String // "viewed" | "shortlisted" | "removed" | "favorited"
  createdAt        DateTime       @default(now())

  @@index([tenantId, decisionStreamId])
  @@index([tenantId, candidateId])
}

model MatchResult {
  id                       String          @id @default(cuid())
  tenantId                 String          @default("default-tenant")
  candidate                Candidate       @relation(fields: [candidateId], references: [id])
  candidateId              String
  jobReq                   JobReq          @relation(fields: [jobReqId], references: [id])
  jobReqId                 String
  score                    Int
  reasons                  Json?
  createdAt                DateTime        @default(now())
  skillScore               Int?
  seniorityScore           Int?
  locationScore            Int?
  agentRun                 AgentRunLog?    @relation(fields: [agentRunId], references: [id])
  agentRunId               String?
  candidateSignalScore     Int?
  candidateSignalBreakdown Json?
  shortlisted              Boolean         @default(false)
  shortlistReason          String?
  feedbackEntries          MatchFeedback[]

  jobCandidate   JobCandidate? @relation("JobCandidateMatchResults", fields: [jobCandidateId], references: [id])
  jobCandidateId String?
  lastMatchFor   JobCandidate? @relation("JobCandidateLastMatch")
  Match          Match?        @relation(fields: [matchId], references: [id])
  matchId        String?

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
  @@index([tenantId, jobCandidateId])
  @@index([tenantId, agentRunId])
}

model JobCandidateNote {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  author         User?        @relation(fields: [authorId], references: [id])
  authorId       String?
  content        String
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model MatchHistory {
  id            String   @id @default(cuid())
  tenantId      String   @default("default-tenant")
  match         Match    @relation(fields: [matchId], references: [id])
  matchId       String
  action        String
  changes       Json
  performedBy   User?    @relation(fields: [performedById], references: [id])
  performedById String?
  createdAt     DateTime @default(now())

  @@index([tenantId, matchId])
}

model JobCandidateHistory {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  action         String
  changes        Json
  performedBy    User?        @relation(fields: [performedById], references: [id])
  performedById  String?
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model JobCandidateScoreHistory {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  score          Float
  reason         String?
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model JobCandidateStep {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  step           String
  status         String // e.g., "Pending", "Completed"
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model JobCandidateStatusHistory {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  status         String
  changedAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model JobCandidateFeedback {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  feedbackText   String
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model MatchFeedback {
  id                String        @id @default(cuid())
  tenantId          String        @default("default-tenant")
  matchResult       MatchResult   @relation(fields: [matchResultId], references: [id])
  matchResultId     String
  jobReqId          String
  candidateId       String
  jobCandidate      JobCandidate? @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId    String?
  user              User          @relation(fields: [userId], references: [id])
  userId            String
  feedback          String
  direction         String?
  outcome           String
  outcomeSource     String?
  matchScore        Int?
  confidenceScore   Int?
  shortlistStrategy String?
  matchSignals      Json?
  guardrailsPreset  String?
  guardrailsConfig  Json?
  guardrailsConfigHash String?
  systemMode        String?
  createdAt         DateTime      @default(now())

  @@unique([tenantId, jobReqId, candidateId, userId])
  @@unique([tenantId, matchResultId, outcome])
  @@index([tenantId, matchResultId])
  @@index([tenantId, jobReqId])
}

model MatchQualitySnapshot {
  id         String   @id @default(cuid())
  tenantId   String   @default("default-tenant")
  scope      String
  scopeRef   String?
  windowDays Int
  mqi        Float
  components Json
  capturedAt DateTime @default(now())

  @@index([tenantId, scope, capturedAt])
  @@index([tenantId, scopeRef])
}

model JobCandidateLabel {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  label          String
  createdAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
  @@index([tenantId, label])
}

model JobCandidateStage {
  id             String       @id @default(cuid())
  tenantId       String       @default("default-tenant")
  jobCandidate   JobCandidate @relation(fields: [jobCandidateId], references: [id])
  jobCandidateId String
  stage          String
  enteredAt      DateTime     @default(now())

  @@index([tenantId, jobCandidateId])
}

model HiringOutcome {
  id               String    @id @default(cuid())
  tenantId         String    @default("default-tenant")
  job              JobReq    @relation(fields: [jobId], references: [id])
  jobId            String
  candidate        Candidate @relation(fields: [candidateId], references: [id])
  candidateId      String
  candidateIdString String?
  status           String
  source           String
  createdAt        DateTime  @default(now())

  @@unique([tenantId, jobId, candidateId])
  @@index([tenantId, jobId])
  @@index([tenantId, candidateId])
}

model OutreachAction {
  id         String   @id @default(cuid())
  tenantId   String   @default("default-tenant")
  actionType String
  status     String
  metadata   Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  candidate   Candidate? @relation(fields: [candidateId], references: [id])
  candidateId String?

  jobReq   JobReq? @relation(fields: [jobReqId], references: [id])
  jobReqId String?

  @@index([tenantId])
  @@index([tenantId, candidateId])
  @@index([tenantId, jobReqId])
}

model TransactionLog {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  source    String
  status    String
  details   Json
  createdAt DateTime @default(now())

  @@index([tenantId])
}

model JobPosting {
  id          String   @id @default(cuid())
  tenantId    String   @default("default-tenant")
  title       String
  description String
  location    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  matches JobPostingMatch[]

  @@index([tenantId])
}

model JobPostingMatch {
  id           String     @id @default(cuid())
  tenantId     String     @default("default-tenant")
  jobPosting   JobPosting @relation(fields: [jobPostingId], references: [id])
  jobPostingId String
  candidate    Candidate  @relation(fields: [candidateId], references: [id])
  candidateId  String
  score        Float
  createdAt    DateTime   @default(now())

  @@index([tenantId, jobPostingId])
  @@index([tenantId, candidateId])
}

model MatchScoreComponent {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  match     Match    @relation(fields: [matchId], references: [id])
  matchId   String
  component String
  score     Float
  createdAt DateTime @default(now())

  @@index([tenantId, matchId])
}

model MetricEvent {
  id        String   @id @default(cuid())
  tenantId  String   @default("default-tenant")
  eventType String
  entityId  String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, eventType])
  @@index([createdAt])
}

model TenantLearningSignal {
  id         String   @id @default(cuid())
  tenantId   String   @default("default-tenant")
  roleFamily String
  industry   String?
  region     String?
  signalType String
  value      Float
  sampleSize Int
  windowDays Int
  capturedAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, signalType])
  @@index([capturedAt])
}

model LearningAggregate {
  id         String   @id @default(cuid())
  roleFamily String
  industry   String?
  region     String?
  signalType String
  value      Float
  sampleSize Int
  windowDays Int
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([signalType, windowDays])
  @@index([roleFamily, industry, region])
}

model BenchmarkRelease {
  id          String   @id @default(cuid())
  version     String
  status      String   @default("draft")
  windowDays  Int
  createdAt   DateTime @default(now())
  publishedAt DateTime?

  metrics BenchmarkMetric[]
}

model BenchmarkMetric {
  id               String             @id @default(cuid())
  releaseId        String
  roleFamily       String
  industry         String?
  region           String?
  metricKey        String
  metricValue      Float
  sampleSize       Int
  methodologyNotes String?
  createdAt        DateTime           @default(now())

  release BenchmarkRelease @relation(fields: [releaseId], references: [id])

  @@index([releaseId])
  @@index([releaseId, roleFamily, metricKey])
}

model InsightSnapshot {
  id          String   @id @default(cuid())
  releaseId   String
  title       String
  subtitle    String?
  audience    String   // "internal" | "client" | "public"
  status      String   // "draft" | "approved" | "published"
  contentJson Json
  createdAt   DateTime @default(now())
  publishedAt DateTime?

  @@index([releaseId])
  @@index([status])
}

model CopilotAudit {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  query     String
  response  Json
  evidence  Json
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, createdAt])
}
